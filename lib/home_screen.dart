// lib/home_screen.dart - PART 1 OF 3
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:google_mobile_ads/google_mobile_ads.dart';
import 'package:google_mlkit_barcode_scanning/google_mlkit_barcode_scanning.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:image_picker/image_picker.dart';
import 'package:liver_wise/services/grocery_service.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:async';
import '../widgets/premium_gate.dart';
import '../controllers/premium_gate_controller.dart';
import 'liverhealthbar.dart';
import '../services/auth_service.dart';
import '../services/error_handling_service.dart';
import '../services/food_classifier_service.dart';
import '../models/favorite_recipe.dart';
import '../pages/search_users_page.dart';
import '../widgets/app_drawer.dart';
import '../config/app_config.dart';
import '../widgets/menu_icon_with_badge.dart';
import '../services/database_service_core.dart';

class NutritionInfo {
  final String productName;
  final double fat;
  final double sodium;
  final double sugar;
  final double calories;

  NutritionInfo({
    required this.productName,
    required this.fat,
    required this.sodium,
    required this.sugar,
    required this.calories,
  });

  factory NutritionInfo.fromJson(Map<String, dynamic> json) {
    final product = json['product'] ?? {};
    final nutriments = product['nutriments'] ?? {};

    double parseDouble(dynamic value) {
      if (value == null) return 0.0;
      return double.tryParse(value.toString()) ?? 0.0;
    }

    return NutritionInfo(
      productName: product['product_name'] ?? 'Unknown product',
      calories: parseDouble(nutriments['energy-kcal_100g']),
      fat: parseDouble(nutriments['fat_100g']),
      sugar: parseDouble(nutriments['sugars_100g']),
      sodium: parseDouble(nutriments['sodium_100g']),
    );
  }
}

class Recipe {
  final String title;
  final String description;
  final List<String> ingredients;
  final String instructions;

  Recipe({
    required this.title,
    required this.description,
    required this.ingredients,
    required this.instructions,
  });

  Map<String, dynamic> toJson() => {
    'title': title,
    'description': description,
    'ingredients': ingredients,
    'instructions': instructions,
  };

  factory Recipe.fromJson(Map<String, dynamic> json) => Recipe(
    title: json['title'] ?? json['name'] ?? '',
    description: json['description'] ?? '',
    ingredients: json['ingredients'] is String 
        ? (json['ingredients'] as String).split(',').map((e) => e.trim()).toList()
        : List<String>.from(json['ingredients'] ?? []),
    instructions: json['instructions'] ?? json['directions'] ?? '',
  );
}

class LiverHealthCalculator {
  static const double fatMax = 20.0;
  static const double sodiumMax = 500.0;
  static const double sugarMax = 20.0;
  static const double calMax = 400.0;

  static int calculate({
    required double fat,
    required double sodium,
    required double sugar,
    required double calories,
  }) {
    double fatScore = 1 - (fat / fatMax).clamp(0, 1);
    double sodiumScore = 1 - (sodium / sodiumMax).clamp(0, 1);
    double sugarScore = 1 - (sugar / sugarMax).clamp(0, 1);
    double calScore = 1 - (calories / calMax).clamp(0, 1);

    double finalScore = (fatScore * 0.3) +
                        (sodiumScore * 0.25) +
                        (sugarScore * 0.25) +
                        (calScore * 0.2);

    return (finalScore * 100).round().clamp(0, 100);
  }
}

class RecipeGenerator {
  // UPDATED: Now uses AI to extract food words with enhanced debug logging
  static Future<List<Recipe>> generateSuggestionsFromProduct(String productName) async {
    AppConfig.debugPrint('üîç Product: $productName');
    
    // Use AI-powered food word extraction
    final foodWords = await FoodClassifierService.extractFoodWords(productName);
    
    if (foodWords.isEmpty) {
      AppConfig.debugPrint('‚ùå No food words found in: $productName');
      return _getHealthyRecipes();
    }
    
    AppConfig.debugPrint('‚úÖ Food words detected: $foodWords');
    
    // Try each food word until we find recipes
    for (String foodWord in foodWords) {
      try {
        AppConfig.debugPrint('üîç Searching for recipes with: $foodWord');
        
        final response = await http.post(
          Uri.parse(AppConfig.cloudflareWorkerQueryEndpoint),
          headers: {'Content-Type': 'application/json'},
          body: jsonEncode({
            'action': 'search_recipes',
            'keyword': foodWord,
            'limit': 5,
          }),
        );

        AppConfig.debugPrint('üì° Response status: ${response.statusCode}');
        AppConfig.debugPrint('üì° Response body: ${response.body}');

        if (response.statusCode == 200) {
          final data = jsonDecode(response.body);
          AppConfig.debugPrint('üìä Decoded data type: ${data.runtimeType}');
          AppConfig.debugPrint('üìä Decoded data: $data');
          
          final recipes = (data as List)
              .map((json) => Recipe.fromJson(json))
              .toList();
          
          if (recipes.isNotEmpty) {
            AppConfig.debugPrint('‚úÖ Found ${recipes.length} recipes for: $foodWord');
            return recipes;
          } else {
            AppConfig.debugPrint('‚ö†Ô∏è No recipes in response for: $foodWord');
          }
        } else {
          AppConfig.debugPrint('‚ùå Non-200 status for "$foodWord": ${response.statusCode}');
        }
      } catch (e) {
        AppConfig.debugPrint('‚ùå Error searching for "$foodWord": $e');
      }
    }
    
    AppConfig.debugPrint('‚ö†Ô∏è No recipes found for any food words: $foodWords - showing fallback recipes');
    return _getHealthyRecipes();
  }

  static List<Recipe> generateSuggestions(int liverHealthScore) {
    if (liverHealthScore >= 75) {
      return _getHealthyRecipes();
    } else if (liverHealthScore >= 50) {
      return _getModerateRecipes();
    } else {
      return _getDetoxRecipes();
    }
  }

  static List<Recipe> _getHealthyRecipes() => [
    Recipe(
      title: "Mediterranean Salmon Bowl",
      description: "Heart-healthy salmon with fresh vegetables",
      ingredients: ["Fresh salmon", "Mixed greens", "Olive oil", "Lemon", "Cherry tomatoes"],
      instructions: "Grill salmon, serve over greens with olive oil and lemon dressing.",
    ),
    Recipe(
      title: "Quinoa Vegetable Stir-fry",
      description: "Protein-rich quinoa with colorful vegetables",
      ingredients: ["Quinoa", "Bell peppers", "Broccoli", "Carrots", "Soy sauce"],
      instructions: "Cook quinoa, stir-fry vegetables, combine and season.",
    ),
  ];

  static List<Recipe> _getModerateRecipes() => [
    Recipe(
      title: "Baked Chicken with Sweet Potato",
      description: "Lean protein with nutrient-rich sweet potato",
      ingredients: ["Chicken breast", "Sweet potato", "Herbs", "Olive oil"],
      instructions: "Season chicken, bake with sweet potato slices until golden.",
    ),
    Recipe(
      title: "Lentil Soup",
      description: "Fiber-rich soup to support liver health",
      ingredients: ["Red lentils", "Carrots", "Celery", "Onions", "Vegetable broth"],
      instructions: "Saut√© vegetables, add lentils and broth, simmer until tender.",
    ),
  ];

  static List<Recipe> _getDetoxRecipes() => [
    Recipe(
      title: "Green Detox Smoothie",
      description: "Liver-cleansing green smoothie",
      ingredients: ["Spinach", "Green apple", "Lemon juice", "Ginger", "Water"],
      instructions: "Blend all ingredients until smooth, serve immediately.",
    ),
    Recipe(
      title: "Steamed Vegetables with Brown Rice",
      description: "Simple, clean eating option",
      ingredients: ["Brown rice", "Broccoli", "Carrots", "Zucchini", "Herbs"],
      instructions: "Steam vegetables, serve over cooked brown rice with herbs.",
    ),
  ];
}

class NutritionApiService {
  static String get baseUrl => AppConfig.openFoodFactsUrl;

  static Future<NutritionInfo?> fetchNutritionInfo(String barcode) async {
    if (barcode.isEmpty) return null;
    final url = "$baseUrl/$barcode.json";

    try {
      final response = await http.get(
        Uri.parse(url),
        headers: {'User-Agent': 'FlutterApp/1.0'},
      ).timeout(Duration(seconds: AppConfig.apiTimeoutSeconds));

      if (response.statusCode == 200) {
        final data = json.decode(response.body);
        if (data['status'] == 1) {
          return NutritionInfo.fromJson(data);
        }
      }
      return null;
    } catch (e) {
      if (AppConfig.enableDebugPrints) {
        print('Nutrition API Error: $e');
      }
      return null;
    }
  }
}

class BarcodeScannerService {
  static Future<String?> scanBarcode(String imagePath) async {
    if (imagePath.isEmpty) return null;
    final inputImage = InputImage.fromFilePath(imagePath);
    final barcodeScanner = BarcodeScanner();

    try {
      final barcodes = await barcodeScanner.processImage(inputImage);
      if (barcodes.isNotEmpty) {
        return barcodes.first.rawValue;
      }
      return null;
    } catch (e) {
      print('Barcode Scanner Error: $e');
      return null;
    } finally {
      await barcodeScanner.close();
    }
  }

  static Future<NutritionInfo?> scanAndLookup(String imagePath) async {
    final barcode = await scanBarcode(imagePath);
    if (barcode == null) return null;
    return await NutritionApiService.fetchNutritionInfo(barcode);
  }
}

class HomePage extends StatefulWidget {
  final bool isPremium;
  const HomePage({super.key, this.isPremium = false});

  @override
  _HomePageState createState() => _HomePageState();
}

class _HomePageState extends State<HomePage> with AutomaticKeepAliveClientMixin {
  bool _isScanning = false;
  List<Map<String, String>> _scannedRecipes = [];
  File? _imageFile;
  String _nutritionText = '';
  int? _liverHealthScore;
  bool _showLiverBar = false;
  bool _isLoading = false;
  List<Recipe> _recipeSuggestions = [];
  List<FavoriteRecipe> _favoriteRecipes = [];
  bool _showInitialView = true;
  NutritionInfo? _currentNutrition;
  late final PremiumGateController _premiumController;
  StreamSubscription? _premiumSubscription;
  bool _isPremium = false;
  int _remainingScans = 3;
  bool _hasUsedAllFreeScans = false;
  InterstitialAd? _interstitialAd;
  bool _isAdReady = false;
  RewardedAd? _rewardedAd;
  bool _isRewardedAdReady = false;
  bool _isDisposed = false;
  final ImagePicker _picker = ImagePicker();

  @override
  bool get wantKeepAlive => true;

  @override
  void initState() {
    super.initState();
    _initializePremiumController();
    _initializeAsync();
    _precacheImages();
  }

  Future<void> _precacheImages() async {
    await precacheImage(
      const AssetImage('assets/backgrounds/home_background.png'),
      context,
    );
    
    await precacheImage(
      const AssetImage('assets/backgrounds/login_background.png'),
      context,
    );
    
    if (MediaQuery.of(context).size.width > 600) {
      await precacheImage(
        const AssetImage('assets/backgrounds/ipad_background.png'),
        context,
      );
    }
  }

  @override
  void dispose() {
    _isDisposed = true;
    _premiumSubscription?.cancel();
    _interstitialAd?.dispose();
    _rewardedAd?.dispose();
    super.dispose();
  }

  void _initializePremiumController() {
    _premiumController = PremiumGateController();
    _premiumSubscription = _premiumController.addListener(() {
      if (mounted && !_isDisposed) {
        setState(() {
          _isPremium = _premiumController.isPremium;
          _remainingScans = _premiumController.remainingScans;
          _hasUsedAllFreeScans = _premiumController.hasUsedAllFreeScans;
        });
      }
    }) as StreamSubscription?;
    setState(() {
      _isPremium = _premiumController.isPremium;
      _remainingScans = _premiumController.remainingScans;
      _hasUsedAllFreeScans = _premiumController.hasUsedAllFreeScans;
    });
  }

  Future<void> _initializeAsync() async {
    try {
      await _premiumController.refresh();
      await _loadFavoriteRecipes();
      // ‚úÖ SYNC FAVORITES FROM DATABASE TO LOCAL CACHE
      await _syncFavoritesFromDatabase();
      _loadInterstitialAd();
      _loadRewardedAd();
    } catch (e) {
      if (mounted) {
        await ErrorHandlingService.handleError(
          context: context,
          error: e,
          category: ErrorHandlingService.initializationError,
          showSnackBar: true,
          customMessage: 'Failed to initialize home screen',
        );
      }
    }
  }

  /// ‚úÖ SYNC FAVORITES FROM DATABASE TO LOCAL CACHE
  Future<void> _syncFavoritesFromDatabase() async {
    try {
      final currentUserId = AuthService.currentUserId;
      if (currentUserId == null) return;

      // Fetch all favorites from database for current user
      final response = await http.post(
        Uri.parse(AppConfig.cloudflareWorkerQueryEndpoint),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({
          'action': 'select',
          'table': 'favorite_recipes_with_details',
          'filters': {'user_id': currentUserId},
          'orderBy': 'created_at',
          'ascending': false,
        }),
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body) as List;
        
        // Convert database records to FavoriteRecipe objects
        final favoriteRecipes = data.map((json) {
          return FavoriteRecipe(
            userId: json['user_id'] ?? '',
            recipeName: json['title'] ?? '',
            ingredients: json['ingredients'] ?? '',
            directions: json['directions'] ?? '',
            createdAt: DateTime.tryParse(json['created_at'] ?? '') ?? DateTime.now(),
          );
        }).toList();

        // Update state
        if (mounted && !_isDisposed) {
          setState(() {
            _favoriteRecipes = favoriteRecipes;
          });
        }

        // ‚úÖ SAVE TO LOCAL CACHE
        await _saveFavoritesToLocalCache(favoriteRecipes);
        print('‚úÖ Synced ${favoriteRecipes.length} favorites from database');
      }
    } catch (e) {
      print('‚ö†Ô∏è Error syncing favorites from database: $e');
    }
  }

  void _loadInterstitialAd() {
    if (_isDisposed) return;
    final adUnitId = AppConfig.interstitialAdId;
    InterstitialAd.load(
      adUnitId: adUnitId,
      request: AdRequest(),
      adLoadCallback: InterstitialAdLoadCallback(
        onAdLoaded: (ad) {
          if (!_isDisposed) {
            _interstitialAd = ad;
            _isAdReady = true;
            ad.setImmersiveMode(true);
          } else {
            ad.dispose();
          }
        },
        onAdFailedToLoad: (error) {
          if (AppConfig.enableDebugPrints) {
            print('InterstitialAd failed to load: $error');
          }
          _isAdReady = false;
        },
      ),
    );
  }

  void _loadRewardedAd() {
    if (_isDisposed) return;
    final adUnitId = AppConfig.rewardedAdId;
    RewardedAd.load(
      adUnitId: adUnitId,
      request: AdRequest(),
      rewardedAdLoadCallback: RewardedAdLoadCallback(
        onAdLoaded: (ad) {
          if (!_isDisposed) {
            _rewardedAd = ad;
            _isRewardedAdReady = true;
          } else {
            ad.dispose();
          }
        },
        onAdFailedToLoad: (error) {
          if (AppConfig.enableDebugPrints) {
            print('RewardedAd failed to load: $error');
          }
          _isRewardedAdReady = false;
        },
      ),
    );
  }

  void _showInterstitialAd(VoidCallback onAdClosed) {
    if (_isDisposed || !_isAdReady || _interstitialAd == null) {
      onAdClosed();
      return;
    }
    _interstitialAd!.fullScreenContentCallback = FullScreenContentCallback(
      onAdShowedFullScreenContent: (ad) {
        print('Interstitial ad showed full screen content');
      },
      onAdDismissedFullScreenContent: (ad) {
        print('Interstitial ad dismissed');
        ad.dispose();
        if (!_isDisposed) {
          _loadInterstitialAd();
        }
        onAdClosed();
      },
      onAdFailedToShowFullScreenContent: (ad, error) {
        print('Interstitial ad failed to show: $error');
        ad.dispose();
        if (!_isDisposed) {
          _loadInterstitialAd();
        }
        onAdClosed();
      },
    );
    _interstitialAd!.show();
    _isAdReady = false;
  }


  void _showRewardedAd() {
    if (_isDisposed) return;
    if (_isRewardedAdReady && _rewardedAd != null) {
      _rewardedAd!.fullScreenContentCallback = FullScreenContentCallback(
        onAdShowedFullScreenContent: (ad) {
          print('Rewarded ad showed full screen content');
        },
        onAdDismissedFullScreenContent: (ad) {
          print('Rewarded ad dismissed');
          ad.dispose();
          if (!_isDisposed) {
            _loadRewardedAd();
          }
        },
        onAdFailedToShowFullScreenContent: (ad, error) {
          print('Rewarded ad failed to show: $error');
          ad.dispose();
          if (!_isDisposed) {
            _loadRewardedAd();
          }
        },
      );
      _rewardedAd!.show(
        onUserEarnedReward: (ad, reward) {
          if (!_isDisposed) {
            print('User earned reward: ${reward.amount} ${reward.type}');
            _premiumController.addBonusScans(1);
            if (mounted) {
              ErrorHandlingService.showSuccess(
                context,
                'Bonus scan earned! You now have ${_premiumController.remainingScans} scans remaining.'
              );
            }
          }
        },
      );
      _isRewardedAdReady = false;
    } else {
      if (mounted) {
        ErrorHandlingService.showSimpleError(
          context,
          'Ad not ready yet. Please try again in a moment.'
        );
      }
    }
  }

  Future<void> _loadFavoriteRecipes() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final favoriteRecipesJson = prefs.getStringList('favorite_recipes_detailed') ?? [];
      if (mounted && !_isDisposed) {
        setState(() {
          _favoriteRecipes = favoriteRecipesJson
              .map((jsonString) {
                try {
                  return FavoriteRecipe.fromJson(json.decode(jsonString));
                } catch (e) {
                  print('Error parsing recipe: $e');
                  return null;
                }
              })
              .where((recipe) => recipe != null)
              .cast<FavoriteRecipe>()
              .toList();
        });
      }
    } catch (e) {
      if (mounted) {
        await ErrorHandlingService.handleError(
          context: context,
          error: e,
          category: ErrorHandlingService.databaseError,
          showSnackBar: true,
          customMessage: 'Failed to load favorite recipes',
        );
      }
    }
  }

  /// ‚úÖ Saves favorite recipes to SharedPreferences for offline access
  Future<void> _saveFavoritesToLocalCache(List<FavoriteRecipe> favorites) async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final favoriteRecipesJson = favorites
          .map((recipe) => jsonEncode(recipe.toJson()))
          .toList();
      await prefs.setStringList('favorite_recipes_detailed', favoriteRecipesJson);
      print('‚úÖ Synced ${favorites.length} favorites to local cache');
    } catch (e) {
      print('‚ö†Ô∏è Error saving favorites to local cache: $e');
    }
  }

  Future<void> _toggleFavoriteRecipe(Recipe recipe) async {
    try {
      final currentUserId = AuthService.currentUserId;
      final currentUsername = await AuthService.fetchCurrentUsername();      
      if (currentUserId == null || currentUsername == null) {
        if (mounted) {
          ErrorHandlingService.showSimpleError(context, 'Please log in to save recipes');
        }
        return;
      }

      // First, search for the recipe in the database to get its ID
      final searchResponse = await http.post(
        Uri.parse(AppConfig.cloudflareWorkerQueryEndpoint),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({
          'action': 'select',
          'table': 'recipes',
          'filters': {'title': recipe.title},
          'limit': 1,
        }),
      );

      if (searchResponse.statusCode != 200) {
        throw Exception('Failed to find recipe in database');
      }

      final recipes = jsonDecode(searchResponse.body) as List;
      if (recipes.isEmpty) {
        if (mounted) {
          ErrorHandlingService.showSimpleError(
            context, 
            'This recipe must be in the database first. Please submit it!'
          );
        }
        return;
      }

      final recipeId = recipes[0]['id'];

      // Check if already favorited
      final checkResponse = await http.post(
        Uri.parse(AppConfig.cloudflareWorkerQueryEndpoint),
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({
          'action': 'select',
          'table': 'favorite_recipes',
          'filters': {
            'user_id': currentUserId,
            'recipe_id': recipeId,
          },
        }),
      );

      final existingFavorites = jsonDecode(checkResponse.body) as List;

      if (existingFavorites.isNotEmpty) {
        // Remove from favorites
        final deleteResponse = await http.post(
          Uri.parse(AppConfig.cloudflareWorkerQueryEndpoint),
          headers: {'Content-Type': 'application/json'},
          body: jsonEncode({
            'action': 'delete',
            'table': 'favorite_recipes',
            'filters': {'id': existingFavorites[0]['id']},
          }),
        );

        if (deleteResponse.statusCode == 200) {
          if (mounted) {
            // Update local state
            setState(() {
              _favoriteRecipes.removeWhere((fav) => fav.recipeName == recipe.title);
            });
            
            // ‚úÖ SYNC TO LOCAL CACHE
            await _saveFavoritesToLocalCache(_favoriteRecipes);
            
            ErrorHandlingService.showSuccess(
              context,
              'Removed "${recipe.title}" from favorites'
            );
          }
        }
      } else {
        // Add to favorites WITH ALL RECIPE DETAILS
        final insertResponse = await http.post(
          Uri.parse(AppConfig.cloudflareWorkerQueryEndpoint),
          headers: {'Content-Type': 'application/json'},
          body: jsonEncode({
            'action': 'insert',
            'table': 'favorite_recipes',
            'data': {
              'user_id': currentUserId,
              'recipe_id': recipeId,
              'username': currentUsername,
              // ‚úÖ ADD ALL THE DETAIL COLUMNS
              'title': recipe.title,
              'description': recipe.description,
              'ingredients': recipe.ingredients.join(', '),
              'directions': recipe.instructions,
            },
          }),
        );

        if (insertResponse.statusCode == 200 || insertResponse.statusCode == 201) {
          if (mounted) {
            // Create FavoriteRecipe object WITH FULL DETAILS
            final favoriteRecipe = FavoriteRecipe(
              userId: currentUserId,
              recipeName: recipe.title,
              ingredients: recipe.ingredients.join(', '),
              directions: recipe.instructions,
              createdAt: DateTime.now(),
            );
            
            setState(() {
              _favoriteRecipes.add(favoriteRecipe);
            });
            
            // ‚úÖ SYNC TO LOCAL CACHE
            await _saveFavoritesToLocalCache(_favoriteRecipes);
            
            ErrorHandlingService.showSuccess(
              context,
              'Added "${recipe.title}" to favorites!'
            );
          }
        }
      }
    } catch (e) {
      if (mounted) {
        await ErrorHandlingService.handleError(
          context: context,
          error: e,
          category: ErrorHandlingService.databaseError,
          customMessage: 'Error saving recipe',
        );
      }
    }
  }

  bool _isRecipeFavorited(String recipeTitle) {
    return _favoriteRecipes.any((fav) => fav.recipeName == recipeTitle);
  }

  void _resetToHome() {
    if (mounted && !_isDisposed) {
      setState(() {
        _showInitialView = true;
        _nutritionText = '';
        _showLiverBar = false;
        _imageFile = null;
        _recipeSuggestions = [];
        _liverHealthScore = null;
        _isLoading = false;
        _scannedRecipes = [];
        _currentNutrition = null;
      });
    }
  }

  Future<void> _performScan() async {
    try {
      if (!_premiumController.canAccessFeature(PremiumFeature.scan)) {
        Navigator.pushNamed(context, '/purchase');
        return;
      }
      if (!_isPremium) {
        _showInterstitialAd(() => _executePerformScan());
      } else {
        _executePerformScan();
      }
    } catch (e) {
      if (mounted) {
        await ErrorHandlingService.handleError(
          context: context,
          error: e,
          category: ErrorHandlingService.scanError,
          customMessage: 'Unable to start scan',
        );
      }
    }
  }

  Future<void> _executePerformScan() async {
    if (_isDisposed) return;
    try {
      setState(() {
        _isScanning = true;
      });
      final success = await _premiumController.useScan();
      if (!success) {
        Navigator.pushNamed(context, '/purchase');
        return;
      }
      await Future.delayed(Duration(seconds: 2));
      if (mounted && !_isDisposed) {
        setState(() {
          _scannedRecipes = [
            {
              'name': 'Tomato Pasta',
              'ingredients': '2 cups pasta, 4 tomatoes, 1 onion, garlic, olive oil',
              'directions': '1. Cook pasta. 2. Saut√© onion and garlic. 3. Add tomatoes. 4. Mix with pasta.',
            },
            {
              'name': 'Vegetable Stir Fry',
              'ingredients': '2 cups mixed vegetables, soy sauce, ginger, garlic, oil',
              'directions': '1. Heat oil in pan. 2. Add ginger and garlic. 3. Add vegetables. 4. Stir fry with soy sauce.',
            },
          ];
        });
        ErrorHandlingService.showSuccess(
          context,
          'Scan successful! ${_premiumController.remainingScans} scans remaining today.'
        );
      }
    } catch (e) {
      if (mounted) {
        await ErrorHandlingService.handleError(
          context: context,
          error: e,
          category: ErrorHandlingService.scanError,
          customMessage: 'Error during scanning',
        );
      }
    } finally {
      if (mounted && !_isDisposed) {
        setState(() {
          _isScanning = false;
        });
      }
    }
  }

  Future<void> _takePhoto() async {
    try {
      if (!_premiumController.canAccessFeature(PremiumFeature.scan)) {
        Navigator.pushNamed(context, '/purchase');
        return;
      }
      if (!_isPremium) {
        _showInterstitialAd(() => _executeTakePhoto());
      } else {
        _executeTakePhoto();
      }
    } catch (e) {
      if (mounted) {
        await ErrorHandlingService.handleError(
          context: context,
          error: e,
          category: ErrorHandlingService.imageError,
          customMessage: 'Unable to access camera',
        );
      }
    }
  }

  Future<void> _executeTakePhoto() async {
    if (_isDisposed) return;
    try {
      if (mounted) {
        setState(() {
          _showInitialView = false;
          _nutritionText = '';
          _showLiverBar = false;
          _imageFile = null;
          _recipeSuggestions = [];
          _isLoading = false;
          _scannedRecipes = [];
        });
      }
      final pickedFile = await _picker.pickImage(
        source: ImageSource.camera,
        imageQuality: 85,
        maxWidth: 1024,
        maxHeight: 1024,
      );
      if (pickedFile != null && mounted && !_isDisposed) {
        setState(() {
          _imageFile = File(pickedFile.path);
        });
      }
    } catch (e) {
      if (mounted) {
        await ErrorHandlingService.handleError(
          context: context,
          error: e,
          category: ErrorHandlingService.imageError,
          customMessage: 'Failed to take photo',
        );
      }
    }
  }

  Future<void> _submitPhoto() async {
    if (_imageFile == null || _isDisposed) return;
    try {
      final success = await _premiumController.useScan();
      if (!success) {
        Navigator.pushNamed(context, '/purchase');
        return;
      }
      if (mounted) {
        setState(() {
          _isLoading = true;
          _nutritionText = '';
          _showLiverBar = false;
          _recipeSuggestions = [];
        });
      }
      final nutrition = await BarcodeScannerService.scanAndLookup(_imageFile!.path);
      if (nutrition == null) {
        if (mounted && !_isDisposed) {
          setState(() {
            _nutritionText = "No barcode found or product not recognized. Please try again.";
            _showLiverBar = false;
            _isLoading = false;
          });
        }
        return;
      }
      final score = LiverHealthCalculator.calculate(
        fat: nutrition.fat,
        sodium: nutrition.sodium,
        sugar: nutrition.sugar,
        calories: nutrition.calories,
      );
      final suggestions = await RecipeGenerator.generateSuggestionsFromProduct(nutrition.productName);
      if (mounted && !_isDisposed) {
        setState(() {
          _nutritionText = _buildNutritionDisplay(nutrition);
          _liverHealthScore = score;
          _showLiverBar = true;
          _isLoading = false;
          _recipeSuggestions = suggestions;
          _currentNutrition = nutrition;
        });
        ErrorHandlingService.showSuccess(
          context,
          'Analysis successful! ${_premiumController.remainingScans} scans remaining today.'
        );
      }
    } catch (e) {
      if (mounted) {
        setState(() {
          _nutritionText = "Error processing image: ${e.toString()}";
          _showLiverBar = false;
          _isLoading = false;
        });
        await ErrorHandlingService.handleError(
          context: context,
          error: e,
          category: ErrorHandlingService.scanError,
          customMessage: 'Failed to analyze image',
          onRetry: _submitPhoto,
        );
      }
    }
  }

  String _buildNutritionDisplay(NutritionInfo nutrition) {
    return "Product: ${nutrition.productName}\n"
           "Energy: ${nutrition.calories.toStringAsFixed(1)} kcal/100g\n"
           "Fat: ${nutrition.fat.toStringAsFixed(1)} g/100g\n"
           "Sugar: ${nutrition.sugar.toStringAsFixed(1)} g/100g\n"
           "Sodium: ${nutrition.sodium.toStringAsFixed(1)} mg/100g";
  }

  Future<void> _searchUsers(String query) async {
    if (query.trim().isEmpty) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Please enter a search term'),
            backgroundColor: Colors.orange,
          ),
        );
      }
      return;
    }
    try {
      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => SearchUsersPage(initialQuery: query),
        ),
      );
    } catch (e) {
      if (mounted) {
        await ErrorHandlingService.handleError(
          context: context,
          error: e,
          category: ErrorHandlingService.navigationError,
          customMessage: 'Error opening user search',
        );
      }
    }
  }

  // Replace this method in home_screen.dart (around line 1071)

  Future<void> _addNutritionToGroceryList() async {
    if (_currentNutrition == null) {
      if (mounted) {
        ErrorHandlingService.showSimpleError(
          context,
          'No nutrition data available',
        );
      }
      return;
    }

    try {
      // ‚úÖ FIX: Add the ENTIRE product name as ONE item
      final productName = _currentNutrition!.productName;
      
      // Add the full product name to grocery list
      await GroceryService.addToGroceryList(productName);

      if (mounted) {
        ErrorHandlingService.showSuccess(
          context,
          'Added "${productName}" to grocery list!',
        );
        Navigator.pushNamed(context, '/grocery-list');
      }
    } catch (e) {
      if (mounted) {
        await ErrorHandlingService.handleError(
          context: context,
          error: e,
          category: ErrorHandlingService.navigationError,
          customMessage: 'Error adding to grocery list',
        );
      }
    }
  }

  Future<void> _addRecipeIngredientsToGroceryList(dynamic recipe) async {
    try {
      List<String> ingredients = [];

      if (recipe is Recipe) {
        // From AI / Nutrition suggestions
        ingredients = recipe.ingredients;
      } 
      else if (recipe is Map<String, String>) {
        // From scanned quick recipes
        ingredients = recipe['ingredients']!
            .split(',')
            .map((e) => e.trim())
            .where((e) => e.isNotEmpty)
            .toList();
      } else {
        throw Exception("Unsupported recipe type");
      }

      if (ingredients.isEmpty) {
        ErrorHandlingService.showSimpleError(
          context,
          'No ingredients found for this recipe.',
        );
        return;
      }

      int addedCount = 0;

      for (String item in ingredients) {
        await GroceryService.addToGroceryList(item);
        addedCount++;
      }

      if (mounted) {
        ErrorHandlingService.showSuccess(
          context,
          'Added $addedCount ingredients to grocery list!',
        );
        Navigator.pushNamed(context, '/grocery-list');
      }

    } catch (e) {
      await ErrorHandlingService.handleError(
        context: context,
        error: e,
        category: ErrorHandlingService.databaseError,
        customMessage: 'Failed to add ingredients to grocery list',
      );
    }
  }

  Future<void> _makeRecipeFromNutrition() async {
    if (_currentNutrition == null) {
      if (mounted) {
        ErrorHandlingService.showSimpleError(
          context,
          'No nutrition data available',
        );
      }
      return;
    }

    try {
      final productName = _currentNutrition!.productName;
      final foodWords = await FoodClassifierService.extractFoodWords(productName);
      final keyword = foodWords.isNotEmpty ? foodWords.join(', ') : productName;

      final recipeDraft = {
        'initialIngredients': keyword,
        'productName': productName,
        'initialTitle': "$productName Recipe",
        'initialDescription': "A recipe idea based on $productName.",
      };

      if (mounted) {
        final result = await Navigator.pushNamed(
          context,
          '/submit-recipe',
          arguments: recipeDraft,
        );

        if (result == true && mounted) {
          ErrorHandlingService.showSuccess(
            context,
            'Recipe submitted successfully!',
          );
          _resetToHome();
        }
      }
    } catch (e) {
      if (mounted) {
        await ErrorHandlingService.handleError(
          context: context,
          error: e,
          category: ErrorHandlingService.navigationError,
          customMessage: 'Error opening recipe submission',
        );
      }
    }
  }

  Widget _buildSearchBar() {
    final TextEditingController searchController = TextEditingController();
    return Container(
      margin: EdgeInsets.only(bottom: 20),
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white.withAlpha((0.95 * 255).toInt()),
        borderRadius: BorderRadius.circular(15),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.1),
            blurRadius: 8,
            offset: Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        children: [
          Row(
            children: [
              Icon(Icons.people, color: Colors.blue.shade700, size: 24),
              SizedBox(width: 8),
              Expanded(
                child: Text(
                  'Find Friends & Share Recipes',
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: Colors.blue.shade800,
                  ),
                ),
              ),
            ],
          ),
          SizedBox(height: 4),
          Text(
            'Search by name, username, or email',
            style: TextStyle(
              fontSize: 12,
              color: Colors.grey.shade600,
              fontStyle: FontStyle.italic,
            ),
          ),
          SizedBox(height: 12),
          Row(
            children: [
              Expanded(
                child: TextField(
                  controller: searchController,
                  decoration: InputDecoration(
                    hintText: 'Try "John Smith" or "jsmith"...',
                    hintStyle: TextStyle(color: Colors.grey.shade400, fontSize: 14),
                    prefixIcon: Icon(Icons.person_search, color: Colors.grey.shade600),
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(25),
                      borderSide: BorderSide(color: Colors.grey.shade300),
                    ),
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(25),
                      borderSide: BorderSide(color: Colors.grey.shade300),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(25),
                      borderSide: BorderSide(color: Colors.blue, width: 2),
                    ),
                    contentPadding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  textInputAction: TextInputAction.search,
                  onSubmitted: (value) => _searchUsers(value),
                ),
              ),
              SizedBox(width: 12),
              ElevatedButton(
                onPressed: () => _searchUsers(searchController.text),
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.blue,
                  foregroundColor: Colors.white,
                  shape: CircleBorder(),
                  padding: EdgeInsets.all(14),
                  elevation: 3,
                ),
                child: Icon(Icons.search, size: 24),
              ),
            ],
          ),
          SizedBox(height: 8),
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(Icons.check_circle, size: 14, color: Colors.green),
              SizedBox(width: 4),
              Text(
                'Search by Name, Username or Email!',
                style: TextStyle(
                  fontSize: 11,
                  color: Colors.green.shade600,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildNutritionRecipeSuggestions() {
    if (_recipeSuggestions.isEmpty) return const SizedBox.shrink();
    return PremiumGate(
      feature: PremiumFeature.viewRecipes,
      featureName: 'Recipe Details',
      featureDescription: 'View full recipe details with ingredients and directions.',
      child: Container(
        margin: const EdgeInsets.all(20),
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Colors.blue.shade800,
          borderRadius: BorderRadius.circular(12),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.1),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text(
              'Health-Based Recipe Suggestions:',
              style: TextStyle(
                fontSize: 20,
                color: Colors.white,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 16),
            ..._recipeSuggestions.map((recipe) => _buildNutritionRecipeCard(recipe)),
          ],
        ),
      ),
    );
  }
// lib/home_screen.dart - PART 3 OF 3 (FINAL)
// This continues from Part 2 - starts at line 1001

  Widget _buildNutritionRecipeCard(Recipe recipe) {
    final isFavorite = _isRecipeFavorited(recipe.title);
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      decoration: BoxDecoration(
        color: Colors.white.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(8),
      ),
      child: ExpansionTile(
        title: Text(
          recipe.title,
          style: const TextStyle(
            fontSize: 16,
            color: Colors.white,
            fontWeight: FontWeight.bold,
          ),
        ),
        trailing: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            PremiumGate(
              feature: PremiumFeature.favoriteRecipes,
              featureName: 'Favorite Recipes',
              child: IconButton(
                icon: Icon(
                  isFavorite ? Icons.favorite : Icons.favorite_border,
                  color: isFavorite ? Colors.red : Colors.white,
                  size: 20,
                ),
                onPressed: () => _toggleFavoriteRecipe(recipe),
              ),
            ),
            Icon(Icons.expand_more, color: Colors.white),
          ],
        ),
        iconColor: Colors.white,
        collapsedIconColor: Colors.white,
        children: [
          Padding(
            padding: const EdgeInsets.all(12.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  recipe.description,
                  style: const TextStyle(fontSize: 14, color: Colors.white70),
                ),
                const SizedBox(height: 8),
                Text(
                  'Ingredients: ${recipe.ingredients.join(', ')}',
                  style: const TextStyle(fontSize: 12, color: Colors.white60),
                ),
                const SizedBox(height: 8),
                Text(
                  'Instructions: ${recipe.instructions}',
                  style: const TextStyle(fontSize: 12, color: Colors.white60),
                ),
                const SizedBox(height: 12),
                Row(
                  children: [
                    Expanded(
                      child: PremiumGate(
                        feature: PremiumFeature.favoriteRecipes,
                        featureName: 'Favorite Recipes',
                        child: ElevatedButton.icon(
                          onPressed: () => _toggleFavoriteRecipe(recipe),
                          icon: Icon(Icons.favorite),
                          label: Text('Save Recipe'),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.red,
                            foregroundColor: Colors.white,
                          ),
                        ),
                      ),
                    ),
                    SizedBox(width: 12),
                    Expanded(
                      child: PremiumGate(
                        feature: PremiumFeature.groceryList,
                        featureName: 'Grocery List',
                        child: ElevatedButton.icon(
                          onPressed: () => _addRecipeIngredientsToGroceryList(recipe),
                          icon: Icon(Icons.add_shopping_cart),
                          label: Text('Add to List'),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.green,
                            foregroundColor: Colors.white,
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInitialView() {
    return Stack(
      children: [
        Positioned.fill(
          child: LayoutBuilder(
            builder: (context, constraints) {
              final isTablet = constraints.maxWidth > 600;
              
              return Image.asset(
                isTablet 
                  ? 'assets/backgrounds/ipad_background.png'
                  : 'assets/backgrounds/home_background.png',
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Container(
                    color: Colors.green.shade50,
                    child: Center(
                      child: Icon(
                        Icons.image_not_supported, 
                        size: 50, 
                        color: Colors.grey,
                      ),
                    ),
                  );
                },
              );
            },
          ),
        ),
        SingleChildScrollView(
          padding: EdgeInsets.all(16),
          child: Column(
            children: [
              _buildSearchBar(),
              Container(
                padding: EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: Colors.white.withAlpha((0.9 * 255).toInt()),
                  borderRadius: BorderRadius.circular(15),
                ),
                child: Column(
                  children: [
                    Icon(Icons.scanner, size: 48, color: Colors.green),
                    SizedBox(height: 12),
                    Text(
                      'Welcome to Liver Food Scanner',
                      style: TextStyle(
                        fontSize: 24,
                        fontWeight: FontWeight.bold,
                        color: Colors.black87,
                      ),
                    ),
                    SizedBox(height: 8),
                    Text(
                      'Scan products to discover amazing recipes and get nutrition insights!',
                      style: TextStyle(fontSize: 16, color: Colors.grey.shade600),
                      textAlign: TextAlign.center,
                    ),
                  ],
                ),
              ),
              SizedBox(height: 30),
              Center(
                child: Column(
                  children: [
                    GestureDetector(
                      onTap: _isScanning ? null : _takePhoto,
                      child: Container(
                        width: 200,
                        height: 200,
                        decoration: BoxDecoration(
                          color: _isScanning 
                              ? Colors.grey 
                              : (_premiumController.canAccessFeature(PremiumFeature.scan) 
                                  ? Colors.blue 
                                  : Colors.red),
                          shape: BoxShape.circle,
                          boxShadow: [
                            BoxShadow(
                              color: Colors.black26,
                              blurRadius: 10,
                              offset: Offset(0, 5),
                            ),
                          ],
                        ),
                        child: Center(
                          child: _isScanning
                              ? Column(
                                  mainAxisAlignment: MainAxisAlignment.center,
                                  children: [
                                    CircularProgressIndicator(color: Colors.white),
                                    SizedBox(height: 16),
                                    Text(
                                      'Scanning...',
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontSize: 16,
                                        fontWeight: FontWeight.bold,
                                      ),
                                    ),
                                  ],
                                )
                              : Column(
                                  mainAxisAlignment: MainAxisAlignment.center,
                                  children: [
                                    Icon(
                                      _premiumController.canAccessFeature(PremiumFeature.scan)
                                          ? Icons.camera_alt
                                          : Icons.lock,
                                      color: Colors.white,
                                      size: 60,
                                    ),
                                    SizedBox(height: 12),
                                    Text(
                                      _premiumController.canAccessFeature(PremiumFeature.scan)
                                          ? 'Tap to Scan'
                                          : 'Upgrade to Scan',
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontSize: 18,
                                        fontWeight: FontWeight.bold,
                                      ),
                                    ),
                                  ],
                                ),
                        ),
                      ),
                    ),
                    SizedBox(height: 20),
                    Container(
                      padding: EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: Colors.white.withAlpha((0.9 * 255).toInt()),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Column(
                        children: [
                          if (!_isPremium) ...[
                            Row(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(
                                  _premiumController.canAccessFeature(PremiumFeature.scan)
                                      ? Icons.check_circle
                                      : Icons.warning,
                                  color: _premiumController.canAccessFeature(PremiumFeature.scan)
                                      ? Colors.green
                                      : Colors.red,
                                  size: 20,
                                ),
                                SizedBox(width: 8),
                                Text(
                                  _premiumController.canAccessFeature(PremiumFeature.scan)
                                      ? 'Free scans remaining: $_remainingScans/3'
                                      : 'Daily scan limit reached!',
                                  style: TextStyle(
                                    fontSize: 16,
                                    color: _premiumController.canAccessFeature(PremiumFeature.scan)
                                        ? Colors.green.shade700
                                        : Colors.red.shade700,
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                              ],
                            ),
                            SizedBox(height: 12),
                            ElevatedButton.icon(
                              onPressed: () {
                                Navigator.pushNamed(context, '/purchase');
                              },
                              icon: Icon(Icons.star),
                              label: Text('Upgrade for Unlimited Scans'),
                              style: ElevatedButton.styleFrom(
                                backgroundColor: Colors.amber,
                                foregroundColor: Colors.white,
                              ),
                            ),
                            SizedBox(height: 8),
                            ElevatedButton.icon(
                              onPressed: _showRewardedAd,
                              icon: Icon(Icons.play_circle_fill),
                              label: Text('Watch Ad for Bonus Scan'),
                              style: ElevatedButton.styleFrom(
                                backgroundColor: Colors.purple,
                                foregroundColor: Colors.white,
                              ),
                            ),
                          ] else ...[
                            Row(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Icon(Icons.star, color: Colors.amber, size: 20),
                                SizedBox(width: 8),
                                Text(
                                  'Premium: Unlimited Scans',
                                  style: TextStyle(
                                    fontSize: 16,
                                    color: Colors.amber.shade700,
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                              ],
                            ),
                          ],
                        ],
                      ),
                    ),
                    SizedBox(height: 20),
                    ElevatedButton.icon(
                      onPressed: _performScan,
                      icon: Icon(Icons.qr_code_scanner),
                      label: Text('Quick Scan Demo'),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.green,
                        foregroundColor: Colors.white,
                      ),
                    ),
                    // TEST BUTTON - For testing AI Food Classifier
                    SizedBox(height: 12),
                    ElevatedButton.icon(
                      onPressed: () async {
                        print('üß™ Testing AI Food Classifier...');
                        final foods = await FoodClassifierService.extractFoodWords('canned tomatoes');
                        print('‚úÖ Foods found: $foods');
                        if (mounted) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(content: Text('Test complete! Found: $foods')),
                          );
                        }
                      },
                      icon: Icon(Icons.science),
                      label: Text('üß™ Test AI Food Detector'),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.purple,
                        foregroundColor: Colors.white,
                      ),
                    ),
                  ],
                ),
              ),
              SizedBox(height: 30),
              if (_scannedRecipes.isNotEmpty) ...[
                PremiumGate(
                  feature: PremiumFeature.viewRecipes,
                  featureName: 'Recipe Details',
                  featureDescription: 'View full recipe details with ingredients and directions.',
                  child: Column(
                    children: [
                      Container(
                        padding: EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: Colors.white.withAlpha((0.9 * 255).toInt()),
                          borderRadius: BorderRadius.circular(10),
                        ),
                        child: Row(
                          children: [
                            Icon(Icons.restaurant, color: Colors.green, size: 24),
                            SizedBox(width: 12),
                            Text(
                              'Recipe Suggestions',
                              style: TextStyle(
                                fontSize: 20,
                                fontWeight: FontWeight.bold,
                                color: Colors.black87,
                              ),
                            ),
                          ],
                        ),
                      ),
                      SizedBox(height: 16),
                      ..._scannedRecipes.map((recipe) => _buildScannedRecipeCard(recipe)),
                    ],
                  ),
                ),
              ],
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildScannedRecipeCard(Map<String, String> recipe) {
    final isFavorite = _isRecipeFavorited(recipe['name']!);
    return Container(
      margin: EdgeInsets.only(bottom: 16),
      decoration: BoxDecoration(
        color: Colors.white.withAlpha((0.9 * 255).toInt()),
        borderRadius: BorderRadius.circular(10),
      ),
      child: ExpansionTile(
        title: Row(
          children: [
            Icon(Icons.restaurant, color: Colors.green),
            SizedBox(width: 8),
            Expanded(
              child: Text(
                recipe['name']!,
                style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
              ),
            ),
          ],
        ),
        trailing: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            PremiumGate(
              feature: PremiumFeature.favoriteRecipes,
              featureName: 'Favorite Recipes',
              child: IconButton(
                icon: Icon(
                  isFavorite ? Icons.favorite : Icons.favorite_border,
                  color: isFavorite ? Colors.red : Colors.grey,
                  size: 20,
                ),
                onPressed: () {
                  final recipeObj = Recipe(
                    title: recipe['name']!,
                    description: 'Scanned recipe',
                    ingredients: recipe['ingredients']!.split(', '),
                    instructions: recipe['directions']!,
                  );
                  _toggleFavoriteRecipe(recipeObj);
                },
              ),
            ),
            Icon(Icons.expand_more),
          ],
        ),
        children: [
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text('Ingredients:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                SizedBox(height: 8),
                Text(recipe['ingredients']!),
                SizedBox(height: 16),
                Text('Directions:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                SizedBox(height: 8),
                Text(recipe['directions']!),
                SizedBox(height: 16),
                Row(
                  children: [
                    Expanded(
                      child: PremiumGate(
                        feature: PremiumFeature.favoriteRecipes,
                        featureName: 'Favorite Recipes',
                        child: ElevatedButton.icon(
                          onPressed: () {
                            final recipeObj = Recipe(
                              title: recipe['name']!,
                              description: 'Scanned recipe',
                              ingredients: recipe['ingredients']!.split(', '),
                              instructions: recipe['directions']!,
                            );
                            _toggleFavoriteRecipe(recipeObj);
                          },
                          icon: Icon(Icons.favorite),
                          label: Text('Save Recipe'),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.red,
                            foregroundColor: Colors.white,
                          ),
                        ),
                      ),
                    ),
                    SizedBox(width: 12),
                    Expanded(
                      child: PremiumGate(
                        feature: PremiumFeature.groceryList,
                        featureName: 'Grocery List',
                        child: ElevatedButton.icon(
                          onPressed: () => _addRecipeIngredientsToGroceryList(recipe),
                          icon: Icon(Icons.add_shopping_cart),
                          label: Text('Add to List'),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.green,
                            foregroundColor: Colors.white,
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildScanningView() {
    return Container(
      decoration: BoxDecoration(
        image: DecorationImage(
          image: AssetImage(
            MediaQuery.of(context).size.width > 600
              ? 'assets/backgrounds/ipad_background.png'
              : 'assets/backgrounds/home_background.png'
          ),
          fit: BoxFit.cover,
        ),
      ),
      child: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            const SizedBox(height: 20),
            // Image Preview - ALWAYS SHOW if available
            if (_imageFile != null)
              Container(
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.2),
                      blurRadius: 8,
                      offset: const Offset(0, 4),
                    ),
                  ],
                ),
                child: ClipRRect(
                  borderRadius: BorderRadius.circular(12),
                  child: Image.file(
                    _imageFile!,
                    width: double.infinity, // FULL WIDTH instead of 200
                    height: 300, // Larger height
                    fit: BoxFit.cover,
                    errorBuilder: (context, error, stackTrace) {
                      return Container(
                        width: double.infinity,
                        height: 300,
                        decoration: BoxDecoration(
                          color: Colors.grey.shade300,
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: Icon(Icons.error, size: 50, color: Colors.red),
                      );
                    },
                  ),
                ),
              ),
            
            const SizedBox(height: 20),
            
            // Action Buttons Row - ALWAYS SHOW
            SingleChildScrollView(
              scrollDirection: Axis.horizontal,
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  ElevatedButton.icon(
                    onPressed: _takePhoto,
                    icon: const Icon(Icons.camera_alt, size: 18),
                    label: const Text('Retake', style: TextStyle(fontSize: 14)),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.blue,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                    ),
                  ),
                  const SizedBox(width: 8),
                  if (_imageFile != null && !_isLoading)
                    ElevatedButton.icon(
                      onPressed: _submitPhoto,
                      icon: const Icon(Icons.send, size: 18),
                      label: const Text('Analyze', style: TextStyle(fontSize: 14)),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.green,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                      ),
                    ),
                  if (_nutritionText.isNotEmpty) ...[
                    const SizedBox(width: 8),
                    ElevatedButton.icon(
                      onPressed: _addNutritionToGroceryList,
                      icon: const Icon(Icons.add_shopping_cart, size: 18),
                      label: const Text('Grocery List', style: TextStyle(fontSize: 14)),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.purple,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                      ),
                    ),
                    const SizedBox(width: 8),
                    ElevatedButton.icon(
                      onPressed: _makeRecipeFromNutrition,
                      icon: const Icon(Icons.restaurant_menu, size: 18),
                      label: const Text('Make Recipe', style: TextStyle(fontSize: 14)),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.teal,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                      ),
                    ),
                  ],
                  const SizedBox(width: 8),
                  ElevatedButton.icon(
                    onPressed: _resetToHome,
                    icon: const Icon(Icons.home, size: 18),
                    label: const Text('Home', style: TextStyle(fontSize: 14)),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.orange,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                    ),
                  ),
                ],
              ),
            ),
            
            const SizedBox(height: 20),
            
            // Loading Indicator
            if (_isLoading)
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.white.withAlpha((0.9 * 255).toInt()),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: const Column(
                  children: [
                    CircularProgressIndicator(),
                    SizedBox(height: 16),
                    Text(
                      'Analyzing nutrition information...',
                      style: TextStyle(fontSize: 16, fontWeight: FontWeight.w500),
                    ),
                  ],
                ),
              ),
            
            // Instruction Card - SHOW WHEN NO NUTRITION DATA YET
            if (_nutritionText.isEmpty && !_isLoading)
              Container(
                padding: const EdgeInsets.all(20),
                margin: const EdgeInsets.symmetric(horizontal: 4),
                decoration: BoxDecoration(
                  color: Colors.white.withAlpha((0.9 * 255).toInt()),
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.1),
                      blurRadius: 8,
                      offset: const Offset(0, 4),
                    ),
                  ],
                ),
                child: Column(
                  children: [
                    Icon(Icons.touch_app, size: 48, color: Colors.green),
                    SizedBox(height: 12),
                    Text(
                      'Ready to Analyze!',
                      style: TextStyle(
                        fontSize: 22,
                        fontWeight: FontWeight.bold,
                        color: Colors.black87,
                      ),
                    ),
                    SizedBox(height: 8),
                    Text(
                      'Tap the "Analyze" button above to scan the barcode and get nutrition information.',
                      style: TextStyle(
                        fontSize: 16,
                        color: Colors.grey.shade700,
                      ),
                      textAlign: TextAlign.center,
                    ),
                    SizedBox(height: 16),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.camera_alt, size: 20, color: Colors.blue),
                        SizedBox(width: 8),
                        Text('Not right? Tap "Retake"', style: TextStyle(color: Colors.grey.shade600)),
                      ],
                    ),
                  ],
                ),
              ),
            
            // Nutrition Information
            if (_nutritionText.isNotEmpty)
              Container(
                padding: const EdgeInsets.all(16),
                margin: const EdgeInsets.symmetric(horizontal: 4),
                decoration: BoxDecoration(
                  color: Colors.green.shade700,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.1),
                      blurRadius: 8,
                      offset: const Offset(0, 4),
                    ),
                  ],
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Icon(Icons.info, color: Colors.white, size: 24),
                        SizedBox(width: 12),
                        Text(
                          'Nutrition Information',
                          style: TextStyle(
                            fontSize: 20,
                            color: Colors.white,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ],
                    ),
                    SizedBox(height: 12),
                    Text(
                      _nutritionText,
                      style: const TextStyle(
                        fontSize: 16,
                        color: Colors.white,
                        fontWeight: FontWeight.w500,
                      ),
                      textAlign: TextAlign.left,
                    ),
                  ],
                ),
              ),
            
            const SizedBox(height: 20),
            
            // Liver Health Bar
            if (_showLiverBar && _liverHealthScore != null)
              Container(
                margin: const EdgeInsets.symmetric(horizontal: 4),
                child: LiverHealthBar(healthScore: _liverHealthScore!),
              ),
            
            const SizedBox(height: 20),
            
            // Recipe Suggestions
            _buildNutritionRecipeSuggestions(),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    super.build(context);
    return Scaffold(
      drawerEnableOpenDragGesture: false,
      appBar: AppBar(
        leading: Builder(
          builder: (context) => IconButton(
            icon: MenuIconWithBadge(),
            onPressed: () => Scaffold.of(context).openDrawer(),
          ),
        ),
        title: Text('Liver Food Scanner'),
        backgroundColor: Colors.green,
        foregroundColor: Colors.white,
        actions: [
          if (!_isPremium)
            IconButton(
              icon: const Icon(Icons.shopping_cart),
              onPressed: () {
                Navigator.pushNamed(context, '/purchase');
              },
            ),
        ],
      ),
      drawer: AppDrawer(currentPage: 'home'),
      body: _showInitialView ? _buildInitialView() : _buildScanningView(),
    );
  }
}